 # RocketMQ——Producer篇：启动过程

在应用层初始化DefaultMQProducer的过程中，以Producer名称或者RPCHook的任一个或两个作为参数初始化DefaultMQProducer对象，内部以这些参数初始化了DefaultMQProducerImpl对象，其中，RPCHook是接口，由业务层来实现doBeforeRequest和doAfterResponse方法。

在初始化之后对DefaultMQProducer对象设置各参数值，其中必须要设置的是NameServer地址（ClientConfig.namesrvAddr），可以设置以"；"分隔的多个地址。

再调用DefaultMQProducer.start方法启动Producer，其实就是在该方法内部调用的DefaultMQProducerImpl.start方法，在该start方法中调用内部的start(boolean startFactory)方法，其中startFactory等于true。大致逻辑如下：

1、检查DefaultMQProducerImpl.ServiceState的状态（初始化状态为ServiceState.CREATE_JUST）；只有状态为CREATE_JUST时才启动该Producer；其他状态均不执行启动过程；

2、将DefaultMQProducerImpl.ServiceState置为start_failed,以免客户端同一个进程中重复启动；

3、检查producerGroup是否合法：不能为空、长度不能大于255、不能等于"DEFAULT_PRODUCER"；若不合法则直接向应用层抛出MQClientException异常；

4、若producerGroup不等于"CLIENT_INNER_PRODUCER"则设置Producer的实例名（instanceName）；调用java的ManagementFactory.getRuntimeMXBean()方法获取该进程的PID作为该Producer的实例名；

5、构建该Producer的ClientID，等于IP地址@instanceName；

6、创建MQClientInstance对象。先检查单例对象MQClientManager的factoryTable:ConcurrentHashMap<String/* clientId */, MQClientInstance>变量中是否存在该ClientID的对象，若存在则直接返回该MQClientInstance对象，若不存在，则创建MQClientInstance对象，并以该ClientID为key值将新创建的MQClientInstance对象存入并返回，将返回的MQClientInstance对象赋值给DefaultMQProducerImpl.mQClientFactory变量；说明一个IP客户端下面的应用，只有在启动多个进程的情况下才会创建多个MQClientInstance对象；在初始化MQClientInstance对象的过程中：

6.1）初始化ClientRemotingProcessor对象，处理接受的事件请求；

6.2）初始化MQClientAPIImpl对象，在初始化过程中，初始化了MQClientAPIImpl.remotingClient:NettyRemotingClient对象，将ClientRemotingProcessor对象作为事件处理器注册到NettyRemotingClient对象中，处理的事件号有：CHECK_TRANSACTION_STATE、NOTIFY_CONSUMER_IDS_CHANGED、RESET_CONSUMER_CLIENT_OFFSET、GET_CONSUMER_STATUS_FROM_CLIENT、GET_CONSUMER_RUNNING_INFO、CONSUME_MESSAGE_DIRECTLY。

6.3）若ClientConfig.namesrvAddr不为空，则拆分成数组存入MQClientAPIImpl.remotingClient变量中；

6.4）初始化PullMessageService、RebalanceService、ConsumerStatsManager服务线程；PullMessageService服务线程是供DefaultMQPushConsumer端使用的，RebalanceService服务线程是供Consumser端使用的；

6.5）初始化producerGroup等于"CLIENT_INNER_PRODUCER"的DefaultMQProducer对象；

7、将DefaultMQProducerImpl对象在MQClientInstance中注册，以producerGroup为key值、DefaultMQProducerImpl对象为values值存入MQClientInstance.producerTable:ConcurrentHashMap<String/* group */, MQProducerInner>变量中，若在该变量中已存在该producerGroup的记录则向应用层抛出MQClientException异常；说明在一个客户端的一个进程下面启动多个Producer时producerGroup名字不能一样，否则无法启动；

8、以主题名"TBW102"为key值，新初始化的TopicPublishInfo对象为value值存入DefaultMQProducerImpl.topicPublishInfoTable变量中；

9、入参startFactory等于true，故调用MQClientInstance.start方法启动MQClientInstance对象；

10、设置DefaultMQProducerImpl的ServiceState为RUNNING；

11、立即调用MQClientInstance.sendHeartbeatToAllBrokerWithLock()方法，在该方法中，第一，向所有在MQClientInstance.brokerAddrTable列表中的Broker发送心跳消息；第二，向Filter过滤服务器发送REGISTER_MESSAGE_FILTER_CLASS请求码，更新过滤服务器中的Filterclass文件；
# RocketMQ集群

## 集群的模式

### 1.1 单 Master

```
单 master 模式, 单个主机模式,只有一个 master 节点,容易出现单点故障,导致整个服务不可用,严重建议不要线上使用
```

###1.2 双 master(多 master)



```
整个集群没有 slave, 只有 master, 最起码得2个以上的 master
优点:配置很简单,单个 master 出现宕机或者维护的时候对应用没有影响,特别是在磁盘配置为 RAID10模式,即时机器宕机也没有关系,磁盘RAID10模式可靠性比较高,消息也基本不会丢(异步刷盘模式下可能会丢失一点点消息,同步刷盘模式下不会丢数据(一条也不丢),性能最高)
缺点:单台机器宕机期间,这台机器上没有被消费的消息在恢复之前不可被订阅,消息的实时性会有影响
```



### 1.3 多 master, 多 slave 模式(异步复制)



```
每一个 master 至少配备一个 slave, 实际开发中,我们会有多对 master-slave ,我们采用 HA(high AVliable) 和异步复制(异步刷盘,也就是 slave 会新开线程异步从 master 上面备份数据过来),主备之间就会存在一定的延迟(很短暂),延迟级别毫秒级
优点:即便是磁盘损坏,消息丢失的也非常少,甚至不丢失,而且消息的实时性不会受到影响,因为即便是 master 挂了,也可以从 slave 上获取数据,此过程对应用透明,不需要人工干预,性能和多 master 是一样的
缺点: 如果 master 硬盘突然损坏,可能会丢失少量数据(因为salve 不是实时从 master 上面复制数据的,可能在时间差内磁盘损坏)
```

###1.4 多 master, 多 slave (同步双写)



```
有多个主机,每个至少一个 slave, 也就是有多对 master-slave,HA 才用同步双写的模式, 也就是发送消息的时候,消息会向master 和 slave 都发起写请求,双方都返回写入成功,才会告诉应用消息发送成功

优点:数据和服务都没有单节点, master 宕机了,消息没有延迟,服务的可用性和数据的可用性非常高
缺点: 性能相对于异步复制略低,大约低10%
```



## 集群搭建

```
正常来说我们至少需要六台机器
nameserver 2台
broker 4台,分别是2台 master 和2天 slave
```

### 配置文件

```
在 rocketmq 的 conf 目录中, morning 为我们提供了不同搭建方式的配置文件,只要我们加载就行了
我们现在使用的是2m-2s async目录下的四个配置文件, 四个配置文件分别有两个是主文件,两个是对应的 slave 文件,也就是我们让四个虚拟机每个加载一个文件即可
```

### 启动 nameserver

```
nohup sh mqnamesrv > ../logs/namesrvrun.log 2>&1 &
```

### 启动 broker

```
nohup sh mqbroker -c 配置文件的位置 -n "nameserver 地址,多个以;区分" autoCreateTopicEnable=true  > ../logs/broker-a.log 2>&1 &
```

